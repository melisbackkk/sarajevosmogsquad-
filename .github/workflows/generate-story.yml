name: Generate and Store Sarajevo AQI Story Images

on:
  # Schedule for 9am and 2pm Sarajevo time (CET/UTC+1)
  # Note: Times are in UTC, so 8:00 and 13:00 UTC = 9am and 2pm CET
  # During CEST (summer time UTC+2), this will run at 10am and 3pm local time
  schedule:
    - cron: '0 8 * * *'   # 9am CET (8am UTC)
    - cron: '0 13 * * *'  # 2pm CET (1pm UTC)
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  generate-story:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Install dependencies
        run: uv pip install --system -e .
      
      - name: Generate story image
        run: python generate_story_img.py
      
      - name: Check if image is new
        id: check_new
        run: |
          # Get the generated image filename
          GENERATED_FILE=$(ls -t stories/*.jpg | head -n 1)
          echo "generated_file=$GENERATED_FILE" >> $GITHUB_OUTPUT
          
          # Check if this file was already committed
          if git ls-files --error-unmatch "$GENERATED_FILE" 2>/dev/null; then
            echo "Image already exists in repository"
            echo "is_new=false" >> $GITHUB_OUTPUT
          else
            echo "New image generated"
            echo "is_new=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push new image
        if: steps.check_new.outputs.is_new == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stories/*.jpg
          git commit -m "Add AQI story image: $(basename ${{ steps.check_new.outputs.generated_file }})"
          git push
      
      - name: Skip - Image already exists
        if: steps.check_new.outputs.is_new == 'false'
        run: echo "Skipping commit - image already exists in repository"

